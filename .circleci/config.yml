version: 2.1

jobs:
  build-and-deploy:
    docker:
      - image: cimg/node:lts

    steps:
      - checkout

      - restore_cache:
          name: Restore pnpm cache
          keys:
            - pnpm-packages-{{ checksum "pnpm-lock.yaml" }}

      - run:
          name: Install dependencies
          command: |
            npx pnpm config set store-dir .pnpm-store
            npx pnpm install --frozen-lockfile

      - save_cache:
          name: Save pnpm cache
          key: pnpm-packages-{{ checksum "pnpm-lock.yaml" }}
          paths:
            - .pnpm-store

      - run:
          name: Build
          command: npx pnpm build

      - run:
          name: Install rsync
          command: sudo apt-get update && sudo apt-get install -y rsync

      - run:
          name: Deploy
          command: |
            rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" dist/ $VPS_USER@$VPS_HOST:/var/www/portfolio/dist/

workflows:
  deploy:
    jobs:
      - build-and-deploy
